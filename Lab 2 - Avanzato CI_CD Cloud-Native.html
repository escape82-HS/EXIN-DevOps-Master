<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced Cloud-Native CI/CD Lab</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <style>
    :root {
      --bg: #0d1117;
      --card-bg: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --accent: #58a6ff;
      --success: #238636;
      --danger: #da3633;
      --warning: #d29922;
      --code-bg: #0d1117;
      --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: var(--font-main);
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
      margin-bottom: 30px;
    }

    h1 { color: var(--text); margin: 0; font-size: 2rem; }
    h2 { color: var(--accent); margin-top: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
    h3 { color: var(--text); font-size: 1.2rem; margin-top: 1.5rem; }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid var(--border);
      margin-right: 8px;
    }
    .badge-adv { background: rgba(210, 153, 34, 0.15); color: var(--warning); border-color: var(--warning); }
    .badge-cloud { background: rgba(88, 166, 255, 0.15); color: var(--accent); border-color: var(--accent); }

    .step-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }

    .step-number {
      position: absolute;
      top: -12px;
      left: 20px;
      background: var(--accent);
      color: #000;
      font-weight: bold;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.85rem;
    }

    pre {
      background: var(--code-bg);
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      border: 1px solid var(--border);
      margin: 10px 0;
    }

    code { font-family: var(--font-mono); font-size: 0.9em; }

    .copy-btn {
      float: right;
      background: var(--border);
      border: none;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .copy-btn:hover { background: var(--accent); color: #000; }

    .info-box {
      background: rgba(88, 166, 255, 0.1);
      border-left: 4px solid var(--accent);
      padding: 12px;
      margin: 15px 0;
      font-size: 0.95rem;
    }

    .concept-box {
      background: rgba(35, 134, 54, 0.1);
      border-left: 4px solid var(--success);
      padding: 12px;
      margin: 15px 0;
    }
    
    .concept-title { font-weight: bold; color: var(--success); display: block; margin-bottom: 4px; }

    details {
      background: rgba(255,255,255,0.03);
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      cursor: pointer;
    }
    summary { font-weight: 600; color: var(--accent); }

    /* Progress Bar */
    .progress-container {
      position: sticky;
      top: 0;
      background: var(--bg);
      padding: 10px 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .progress-bar {
      flex-grow: 1;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      margin: 0 15px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--success);
      width: 0%;
      transition: width 0.3s ease;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
      accent-color: var(--success);
    }

    footer {
      text-align: center;
      margin-top: 50px;
      color: #8b949e;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="progress-container">
    <strong>Progresso Lab</strong>
    <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
    <span id="progressText">0%</span>
  </div>

  <header>
    <h1>Cloud-Native CI/CD: Docker, Matrix & Security</h1>
    <div style="margin-top: 10px;">
      <span class="badge badge-adv">Livello: Avanzato</span>
      <span class="badge badge-cloud">Zero Install (Browser Only)</span>
      <span class="badge">1 Ora</span>
    </div>
    <p>
      In questo laboratorio costruirai una pipeline completa <strong>DevSecOps</strong> utilizzando GitHub Codespaces (ambiente di sviluppo cloud) e GitHub Actions. 
      Non useremo semplici script shell, ma container Docker, scansioni di sicurezza e registri di immagini.
    </p>
  </header>

  <div class="info-box">
    <strong>Requisiti:</strong> Un account GitHub gratuito. Non serve installare nulla sul tuo PC.
  </div>

  <!-- STEP 1 -->
  <div class="step-card">
    <span class="step-number">Step 1</span>
    <h3>Setup Ambiente Cloud (Codespaces)</h3>
    <p>Invece di clonare in locale, useremo un ambiente VS Code nel cloud.</p>
    <ol>
      <li>Vai su <a href="https://github.com/new" target="_blank" style="color:var(--accent)">github.com/new</a> e crea una nuova repository pubblica chiamata <code>adv-cicd-lab</code>.</li>
      <li>Aggiungi un <strong>README</strong> file (importante per inizializzare il branch main).</li>
      <li>Una volta creata, clicca sul pulsante verde <strong>Code</strong> > Tab <strong>Codespaces</strong> > <strong>Create codespace on main</strong>.</li>
    </ol>
    <p>Si aprir√† un editor VS Code completo nel tuo browser. Aspetta che finisca il caricamento.</p>
    
    <div class="checkbox-wrapper">
      <label><input type="checkbox" class="step-check"> Codespace avviato e terminale pronto.</label>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="step-card">
    <span class="step-number">Step 2</span>
    <h3>Creazione App & Dockerfile Ottimizzato</h3>
    <p>Creiamo una mini API Node.js e prepariamo un Dockerfile <em>multi-stage</em> (best practice per ridurre le dimensioni dell'immagine).</p>
    
    <p>Nel terminale del Codespace, esegui:</p>
    <pre><code class="language-bash">npm init -y
npm install express
# Crea la cartella src
mkdir src</code></pre>

    <p>Crea il file <code>src/index.js</code> (tasto destro nella barra laterale o usa `touch`):</p>
    <pre><code class="language-javascript">const express = require('express');
const app = express();
const port = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.json({ message: 'Hello Cloud Native DevOps!', version: '1.0.0' });
});

app.get('/health', (req, res) => {
  res.status(200).json({ status: 'OK' });
});

if (require.main === module) {
  app.listen(port, () => console.log(`App running on port ${port}`));
}

module.exports = app; // Export per i test</code></pre>

    <p>Crea un file <code>Dockerfile</code> nella root del progetto:</p>
    <pre><code class="language-dockerfile"># Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Stage 2: Runtime (Immagine minimale)
FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY src ./src
COPY package.json ./

EXPOSE 3000
CMD ["node", "src/index.js"]</code></pre>

    <div class="concept-box">
      <span class="concept-title">Concetto Avanzato: Multi-stage Build</span>
      Usiamo due <code>FROM</code>. Il primo installa le dipendenze. Il secondo copia solo il necessario. Risultato: immagine pi√π piccola e sicura (niente cache di npm o tool di build in produzione).
    </div>

    <div class="checkbox-wrapper">
      <label><input type="checkbox" class="step-check"> App e Dockerfile creati.</label>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="step-card">
    <span class="step-number">Step 3</span>
    <h3>Pipeline CI: Matrix Testing & Security</h3>
    <p>Ora creiamo il workflow per le <strong>Pull Request</strong>. Vogliamo testare su pi√π versioni di Node e fare una scansione di sicurezza.</p>
    
    <p>1. Crea un test banale. Crea <code>src/index.test.js</code>:</p>
    <pre><code class="language-javascript">const assert = require('assert');
const app = require('./index');

// Mock test semplice
assert.ok(app);
console.log("Test Passed");</code></pre>

    <p>2. Aggiorna <code>package.json</code> per includere lo script di test:</p>
    <pre><code class="language-json">"scripts": {
  "test": "node src/index.test.js",
  "start": "node src/index.js"
},</code></pre>

    <p>3. Crea la directory <code>.github/workflows</code> e il file <code>ci-pr.yml</code>:</p>
    <pre><code class="language-yaml">name: CI - Pull Request

on:
  pull_request:
    branches: [ "main" ]

jobs:
  # JOB 1: Test su matrice di versioni
  unit-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x] # Testiamo su due versioni LTS
    
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm' # Abilita cache automatica
    - run: npm ci
    - run: npm test

  # JOB 2: Security Scan (Trivy)
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build image for scanning
        run: docker build -t myapp:${{ github.sha }} .
        
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:${{ github.sha }}'
          format: 'table'
          exit-code: '1' # Fallisce la pipeline se trova vulnerabilit√† critiche
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'</code></pre>

    <div class="concept-box">
      <span class="concept-title">Concetto Avanzato: DevSecOps</span>
      Integriamo <strong>Trivy</strong> direttamente nella CI. Se la nostra immagine Docker ha vulnerabilit√† critiche note (CVE), la pipeline fallisce e impedisce il merge.
    </div>

    <div class="checkbox-wrapper">
      <label><input type="checkbox" class="step-check"> Workflow CI creato con Matrix e Trivy.</label>
    </div>
  </div>

  <!-- STEP 4 -->
  <div class="step-card">
    <span class="step-number">Step 4</span>
    <h3>Pipeline CD: Build & Push to Registry</h3>
    <p>Quando il codice arriva su <code>main</code>, costruiamo l'immagine Docker e la pubblichiamo su <strong>GitHub Container Registry (GHCR)</strong>.</p>

    <p>Crea il file <code>.github/workflows/cd-deploy.yml</code>:</p>
    <pre><code class="language-yaml">name: CD - Build & Push

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Necessario per pushare su GHCR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}</code></pre>

    <div class="info-box">
      Nota l'uso di <code>GITHUB_TOKEN</code>. GitHub lo crea automaticamente e noi gli diamo il permesso <code>packages: write</code> per permettere l'upload dell'immagine senza dover gestire password manuali.
    </div>

    <div class="checkbox-wrapper">
      <label><input type="checkbox" class="step-check"> Workflow CD configurato per GHCR.</label>
    </div>
  </div>

  <!-- STEP 5 -->
  <div class="step-card">
    <span class="step-number">Step 5</span>
    <h3>Esecuzione e Verifica</h3>
    <p>√à il momento di vedere tutto in azione simulando il flusso di lavoro di un team.</p>

    <ol>
      <li><strong>Commit & Push:</strong> Nel terminale Codespaces:
        <pre><code class="language-bash">git add .
git commit -m "feat: init app with advanced pipelines"
git push origin main</code></pre>
      </li>
      <li><strong>Osserva la CD:</strong> Vai nel tab <strong>Actions</strong> su GitHub. Vedrai partire il workflow "CD - Build & Push".
        <ul><li>Se diventa verde, vai nella home della repo. Nella colonna destra dovresti vedere <strong>Packages</strong> con la tua immagine Docker.</li></ul>
      </li>
      <li><strong>Simula una PR (Test CI):</strong>
        <pre><code class="language-bash">git checkout -b feature/new-endpoint
# Modifica src/index.js aggiungendo un commento o uno spazio
git commit -am "chore: change for PR"
git push origin feature/new-endpoint</code></pre>
      </li>
      <li>Apri una <strong>Pull Request</strong> su GitHub da questo branch verso main.</li>
      <li><strong>Osserva la CI:</strong> Vedrai partire i test in parallelo (Matrix 18.x e 20.x) e la scansione di sicurezza di Trivy.</li>
    </ol>

    <details>
      <summary>Voglio vedere l'immagine scaricata!</summary>
      <p>Se la CD ha successo, chiunque (se la repo √® pubblica) pu√≤ scaricare la tua app con Docker:</p>
      <code>docker pull ghcr.io/TUO_USER/adv-cicd-lab:latest</code>
    </details>

    <div class="checkbox-wrapper">
      <label><input type="checkbox" class="step-check"> Pipeline eseguite con successo (Verde).</label>
    </div>
  </div>

  <!-- TROUBLESHOOTING -->
  <div class="step-card" style="border-color: var(--warning);">
    <h3>Troubleshooting Comune</h3>
    <ul>
      <li><strong>Errore 403 su GHCR Push:</strong> Hai dimenticato la sezione <code>permissions: packages: write</code> nel file YAML CD?</li>
      <li><strong>Trivy fallisce:</strong> L'immagine base <code>node:20-alpine</code> √® solitamente sicura, ma se Trivy trova una vulnerabilit√† critica, la pipeline si blocca. Questo √® il comportamento desiderato! Per il lab, puoi cambiare <code>exit-code: '1'</code> in <code>'0'</code> nel file YAML per vedere solo il report senza bloccare.</li>
      <li><strong>Git email error:</strong> Se Codespaces si lamenta dell'email, esegui:
        <code>git config --global user.email "tu@example.com" && git config --global user.name "Tu"</code>
      </li>
    </ul>
  </div>

  <footer>
    <p>DevOps Master Lab - Advanced CI/CD Module</p>
    <button onclick="window.print()" style="background:none; border:none; color:var(--accent); cursor:pointer; text-decoration:underline;">Stampa / Salva come PDF</button>
  </footer>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
  hljs.highlightAll();

  // Gestione Checkbox e Progress Bar
  const checkboxes = document.querySelectorAll('.step-check');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');

  function updateProgress() {
    const total = checkboxes.length;
    const checked = document.querySelectorAll('.step-check:checked').length;
    const percent = Math.round((checked / total) * 100);
    
    progressBar.style.width = percent + '%';
    progressText.innerText = percent + '%';
    
    if(percent === 100) {
      progressBar.style.backgroundColor = '#3fb950'; // Bright green
      confettiEffect();
    }
  }

  checkboxes.forEach(cb => cb.addEventListener('change', updateProgress));

  // Copy button logic
  document.querySelectorAll('pre').forEach(block => {
    const button = document.createElement('button');
    button.className = 'copy-btn';
    button.innerText = 'Copy';
    button.addEventListener('click', () => {
      const code = block.querySelector('code').innerText;
      navigator.clipboard.writeText(code);
      button.innerText = 'Copied!';
      setTimeout(() => button.innerText = 'Copy', 2000);
    });
    block.insertBefore(button, block.firstChild);
  });

  function confettiEffect() {
    // Semplice effetto visivo console o alert per gratificazione
    console.log("üéâ Lab Completato!"); 
  }
</script>

</body>
</html>